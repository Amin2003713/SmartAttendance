@page "/Login"

<MudContainer MaxWidth="MaxWidth.Small"
              Class="d-flex justify-center align-center"
              Style="min-height: 100svh; padding: 0 !important;">
    <MudCard Elevation="10" Style="border-radius: 20px; width: 100%; padding: 20px; margin: 20px;">

        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="3">
            <MudImage
                Src="_content/Ui.Components/Icons/login.png"
                Alt="لوگوی ورود"
                Width="250"
                Height="250"
                ObjectFit="ObjectFit.Contain"
                ObjectPosition="ObjectPosition.Center"
            />

            <MudText Typo="Typo.h1" Align="Align.Center">
                به سامانه نوبت‌دهی خوش آمدید
            </MudText>
        </MudStack>

        <!-- Login Form -->
        <AppForm TModel="LoginRequest" Model="Request" OnValidSubmit="LoginAsync">
            <FormProps>

                <!-- Username -->
                <MudTextField
                    For="@(() => Request.PhoneNumber)"
                    @bind-Value="Request.PhoneNumber"
                    Label="نام کاربری"
                    Variant="Variant.Outlined"
                    Margin="Margin.Normal"
                    FullWidth="true"
                    HelperText="نام کاربری خود را وارد کنید(تلفن همراه)"
                    HelperTextOnFocus/>

                <!-- Password -->
                <MudTextField
                    For="@(() => Request.Password)"
                    @bind-Value="Request.Password"
                    Label="رمز عبور"
                    InputType="@_passwordInput"
                    Adornment="Adornment.End"
                    AdornmentIcon="@(_passwordInput == InputType.Password ? MaterialIcons.Filled.Visibility : MaterialIcons.Filled.VisibilityOff)"
                    OnAdornmentClick="ShowPassword"
                    Variant="Variant.Outlined"
                    Margin="Margin.Normal"
                    FullWidth="true"
                    HelperTextOnFocus/>

                <!-- Forgot Password / Register Links -->
                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2" Reverse>
                    <MudLink
                        OnClick="GoToForgotPassword"
                        Color="Color.Info"
                        Disabled="@string.IsNullOrWhiteSpace(Request.PhoneNumber)"
                        Underline="Underline.Hover"
                        Typo="Typo.h5"> فراموشی رمز عبور؟
                    </MudLink>

                    <MudSpacer/>

                    <MudLink
                        OnClick="GoToRegister"
                        Color="Color.Tertiary"
                        Underline="Underline.Hover"
                        Typo="Typo.h5">
                        ثبت‌نام
                    </MudLink>
                </MudStack>
            </FormProps>

            <!-- Login Button -->
            <SubmitButton>
                <MudStack Class="mt-4" Row="false">
                    <MudButton
                        Color="Color.Primary"
                        Variant="Variant.Filled"
                        ButtonType="ButtonType.Submit"
                        FullWidth="true">
                        @if (ApiCalling)
                        {
                            <CircularProgress Size="Size.Small" Color="Color.Info"/>
                        }
                        else
                        {
                            @("ورود")
                        }
                    </MudButton>
                </MudStack>
            </SubmitButton>
        </AppForm>

    </MudCard>
</MudContainer>

@code {
    

    

    private LoginRequest Request { get;  } = new ();
    private bool ApiCalling { get; set; }
    private InputType _passwordInput = InputType.Password;

    private void ShowPassword()
    {
        _passwordInput = _passwordInput == InputType.Password
            ? InputType.Text
            : InputType.Password;
    }

    private async Task LoginAsync(LoginRequest request)
    {
        ApiCalling = true;

        try
        {
            await Mediator.Send(Request);
        }
        catch (Exception ex)
        {
            //
        }
        finally
        {
            ApiCalling = false;
            StateHasChanged();
        }
    }

    private void GoToForgotPassword()
    {
        NavigationManager.NavigateTo($"/forgot-password?Username={Request.PhoneNumber}");
    }

    private void GoToRegister()
    {
        NavigationManager.NavigateTo("/register");
    }

}
