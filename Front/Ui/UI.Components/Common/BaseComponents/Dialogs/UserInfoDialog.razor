@using App.Applications.Users.Requests.ChangeRoles
@using App.Applications.Users.Requests.UpdateUser
@using App.Applications.Users.Requests.UserInfos
@using App.Domain.Users
<MudDialog>
    <DialogContent>

        <MudStack Spacing="2">
            <!-- دکمه‌ی سوییچ حالت -->
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.h6">اطلاعات کاربر(@(Model.FirstName + " " + Model.LastName ))</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="@(_Editing ? Color.Secondary : Color.Primary)"
                           OnClick="ToggleEdit">
                    @(_Editing ? "بازگشت به نمایش" : "ویرایش")

                </MudButton>
            </MudStack>

            <MudForm @ref="_form" Model="_editModel" Disabled="!_Editing">
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField Variant="Variant.Outlined" @bind-Value="StateProvider.User!.UserName"
                                      Label="نام کاربری" ReadOnly Disabled/>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editModel.Email" Variant="Variant.Outlined" Label="ایمیل"/>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editModel.FirstName" Label="نام" Variant="Variant.Outlined"/>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editModel.LastName" Variant="Variant.Outlined"
                                      Label="نام خانوادگی"/>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="StateProvider.User!.PhoneNumber" ReadOnly Disabled
                                      Variant="Variant.Outlined" Label="شماره تماس"/>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect
                            T="string"
                            @bind-Value="_newRole"
                            Label="نقش"
                            Disabled="@(!StateProvider.User!.Roles.Contains("Doctor"))"
                            Variant="Variant.Outlined"
                            Margin="Margin.Normal"
                            HelperTextOnFocus>
                            @foreach (var value in Roles)
                            {
                                <MudSelectItem T="string" Value="value">@ToPersian(value)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="12">
                        <MudTextField Variant="Variant.Outlined" @bind-Value="_editModel.Address" Label="آدرس"/>
                    </MudItem>
                </MudGrid>
            </MudForm>

        </MudStack>

    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Info" OnClick="@(() => MudDialog.Cancel())">انصراف</MudButton>
        <MudButton Color="@(_Editing ? Color.Success : Color.Warning)" OnClick="Submit">
            @(_Editing ? "ذخیره" : "تأیید") ؟
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    

    

    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public UserInfo? Model { get; set; }
    [Parameter] public bool AllowEdit { get; set; } = true;


    public bool _Editing { get; set; }

    private MudForm?          _form;
    private UpdateUserRequest _editModel = new();
    private string?           _newRole;

    public string[] Roles => GetRoles();

    private string[] GetRoles()
    {
        if (StateProvider.User!.Roles!.Contains("Doctor"))
            return
            [
                "Secretary",
                "Patient"
            ];

        if (StateProvider.User!.Roles!.Contains("Secretary"))
            return ["Patient"];

        return [];
    }


    protected override void OnParametersSet()
    {
        if (Model is not null)
        {
            _editModel = new UpdateUserRequest
            {
                FirstName = Model.FirstName,
                LastName  = Model.LastName,

                Address = Model.Address,

                Email = Model.Email,
                userId = long.Parse(Model.Id)
            };

            _newRole = Model.Roles[0];
        }
    }

    private void ToggleEdit()
    {
        if (!AllowEdit) return;

        _Editing = !_Editing;
    }

    private async Task Submit()
    {
        if (_Editing)
        {
            if (_form is not null)
            {
                await _form.Validate();
                if (!_form.IsValid) return;

                if (Model!.Roles.First() != _newRole)
                    await Mediator.Send(new ChangeRoleRequest(Model.Id , _newRole));


                await Mediator.Send(_editModel);

                var newInfo = await Mediator.Send(new UserInfoByIdRequest(long.Parse(Model!.Id)));
                _editModel = newInfo.Adapt<UpdateUserRequest>();
                _Editing = false;
                StateHasChanged();
            }
        }
        else
        {
            MudDialog.Close();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string ToPersian(string value)
    {
        return value switch
               {
                   "Secretary" => "منشی",
                   "Patient"   => "بیمار",
                   "Doctor"    => "دکتر",
                   _           => throw new ArgumentOutOfRangeException(nameof(value), value, null)
               };
    }

}
