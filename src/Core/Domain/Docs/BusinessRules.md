# قوانین تجاری دامنه (Business Rules)

## RBAC
- فقط Admin می‌تواند حساب کاربر را قفل/باز کند.
- Professor می‌تواند ثبت دستی حضور را انجام دهد؛ Student مجاز نیست.
- تغییر ظرفیت طرح فقط توسط Admin/Professor مسئول طرح مجاز است.

## مدیریت ظرفیت طرح
- `PlanCapacity.Capacity > 0` و `Reserved <= Capacity`.
- `RegisterStudent` در صورت پر بودن ظرفیت، دانشجو را در صف انتظار قرار می‌دهد.
- `CancelEnrollment` یک ظرفیت آزاد می‌کند و اگر صف انتظار خالی نباشد، اولین نفر ثبت‌نام می‌شود.

## همگام‌سازی آفلاین (Idempotency)
- هر فراخوانی `SyncOfflineAsync` باید بدون اثر جانبی تکراری باشد.
- رکورد با وضعیت `OfflineSynced` پس از همگام‌سازی به `Present` ارتقا می‌یابد.

## اعتبارسنجی QR/GPS
- QR باید معتبر و غیرمنقضی باشد.
- فاصله GPS دانشجو تا درگاه ورود باید در شعاع مجاز باشد.

## فرایند معذوریت
- تایید معذوریت نیازمند دلیل معتبر است.
- اگر وضعیت قبلی `Absent` یا `Late` باشد، پس از تایید به `Excused` تبدیل می‌شود.

## امتیازدهی حضور
- توسط `IPointsCalculationService` محاسبه می‌شود.
- معذوریت می‌تواند جریمه تاخیر/غیبت را تعدیل کند.